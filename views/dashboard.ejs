<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Terp Notes</title>
    <link rel="stylesheet" href="/styles/main.css" />
</head>

<body>
    <header class="topbar">
        <h2>Terp Notes</h2>
        <div class="user-info">
            Welcome, <strong>
                <%= firstname %>
            </strong>
            <span class="user-role role-<%= user.role %>">
                <%= user.role %>
            </span>
            <% if (user.role==='admin' ) { %>
                | <a href="/admin" class="logout-btn">Admin Panel</a>
                <% } %>
                    | <a href="/profile" class="logout-btn">My Profile</a>
                    | <a href="/logout" class="logout-btn">Logout</a>
        </div>
    </header>

    <main class="container">
        <!-- Announcements Section -->
        <% if (announcements && announcements.length> 0) { %>
            <% announcements.forEach(announcement=> { %>
                <div class="announcement-banner announcement-banner-<%= announcement.type %>">
                    <div style="flex: 1; font-weight: 600;">
                        <%= announcement.message %>
                    </div>
                </div>
                <% }); %>
                    <% } %>

                        <div class="dashboard-controls">
                            <div class="search-bar">
                                <input type="text" id="searchInput" placeholder="Search notes..." />
                                <button type="button" onclick="applyFilters()">Search</button>
                            </div>
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin: 0.5rem 0; flex-wrap: wrap; gap: 1rem;">
                                <p style="color: #6B7280; font-size: 0.875rem; margin: 0;">
                                    üí° <strong>Tip:</strong> Click Year or Semester filters to select multiple options
                                </p>
                                <label
                                    style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-size: 0.875rem; color: var(--umd-red); font-weight: 600;">
                                    <input type="checkbox" id="myFilesToggle" onchange="applyFilters()"
                                        style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--umd-red);">
                                    <span>üìÅ Show Only My Files</span>
                                </label>
                            </div>

                            <div class="filter-controls">
                                <select id="majorFilter" class="filter-select" onchange="handleMajorChange()">
                                    <option value="">All Majors</option>
                                    <% majors.forEach(major=> { %>
                                        <option value="<%= major %>">
                                            <%= major %>
                                        </option>
                                        <% }); %>
                                </select>

                                <select id="classFilter" class="filter-select" onchange="handleClassChange()">
                                    <option value="">All Classes</option>
                                    <% classCodes.forEach(code=> { %>
                                        <option value="<%= code %>"
                                            data-major="<%= code.replace(/[0-9]/g, '').trim() %>">
                                            <%= code %>
                                        </option>
                                        <% }); %>
                                </select>

                                <!-- Year Multi-Select Dropdown -->
                                <div class="multi-select-wrapper">
                                    <button type="button" class="multi-select-btn" id="yearBtn"
                                        onclick="toggleDropdown('year')">
                                        <span id="yearLabel">All Years</span>
                                        <span class="dropdown-arrow">‚ñº</span>
                                    </button>
                                    <div class="multi-select-dropdown" id="yearDropdown">
                                        <% years.forEach(year=> { %>
                                            <label class="multi-select-option">
                                                <input type="checkbox" value="<%= year %>"
                                                    onchange="updateMultiSelect('year')">
                                                <span>
                                                    <%= year %>
                                                </span>
                                            </label>
                                            <% }); %>
                                    </div>
                                </div>

                                <!-- Semester Multi-Select Dropdown -->
                                <div class="multi-select-wrapper">
                                    <button type="button" class="multi-select-btn" id="semesterBtn"
                                        onclick="toggleDropdown('semester')">
                                        <span id="semesterLabel">All Semesters</span>
                                        <span class="dropdown-arrow">‚ñº</span>
                                    </button>
                                    <div class="multi-select-dropdown" id="semesterDropdown">
                                        <% semesters.forEach(semester=> { %>
                                            <label class="multi-select-option">
                                                <input type="checkbox" value="<%= semester %>"
                                                    onchange="updateMultiSelect('semester')">
                                                <span>
                                                    <%= semester %>
                                                </span>
                                            </label>
                                            <% }); %>
                                    </div>
                                </div>

                                <input type="text" id="professorFilter" class="filter-select"
                                    placeholder="üîç Search Professor..." onkeyup="applyFilters()"
                                    style="padding: 0.5rem 1rem;" />

                                <select id="sortFilter" class="filter-select" onchange="applyFilters()">
                                    <option value="newest">Newest First</option>
                                    <option value="oldest">Oldest First</option>
                                    <option value="name">Name A-Z</option>
                                </select>
                            </div>
                        </div>

                        <section class="file-list">
                            <% if (files.length===0) { %>
                                <div class="empty-state">
                                    <h3>No notes found</h3>
                                    <p>Be the first to share notes for your class!</p>
                                </div>
                                <% } else { %>
                                    <div class="file-grid">
                                        <% files.forEach(file=> { %>
                                            <div class="file-card animate-fade-in" data-class="<%= file.classCode %>"
                                                data-major="<%= file.major || '' %>"
                                                data-semester="<%= file.semester || '' %>"
                                                data-year="<%= file.year || '' %>"
                                                data-professor="<%= (file.professor || '').toLowerCase() %>"
                                                data-uploader="<%= file.uploadedBy %>"
                                                data-name="<%= file.originalName.toLowerCase() %>"
                                                data-date="<%= new Date(file.uploadDate).getTime() %>">
                                                <div class="file-header">
                                                    <div class="file-icon">üìÑ</div>
                                                    <div class="file-info">
                                                        <h3>
                                                            <%= file.originalName %>
                                                        </h3>
                                                    </div>
                                                </div>

                                                <div class="file-meta">
                                                    <% if (file.virusScanStatus) { %>
                                                        <div class="file-meta-item">
                                                            <strong>Security:</strong>
                                                            <% if (file.virusScanStatus==='clean' ) { %>
                                                                <span class="scan-badge scan-clean">‚úì Virus
                                                                    Scanned</span>
                                                                <% } else if (file.virusScanStatus==='pending' ) { %>
                                                                    <span class="scan-badge scan-pending">‚è≥
                                                                        Scanning...</span>
                                                                    <% } else if (file.virusScanStatus==='error' ) { %>
                                                                        <span class="scan-badge scan-error">‚ö†Ô∏è Scan
                                                                            Error</span>
                                                                        <% } %>
                                                        </div>
                                                        <% } %>
                                                            <% if (file.major) { %>
                                                                <div class="file-meta-item">
                                                                    <strong>Major:</strong> <span class="major-badge">
                                                                        <%= file.major %>
                                                                    </span>
                                                                </div>
                                                                <% } %>
                                                                    <% if (file.classCode) { %>
                                                                        <div class="file-meta-item">
                                                                            <strong>Class:</strong> <span
                                                                                class="class-code-badge">
                                                                                <%= file.classCode %>
                                                                            </span>
                                                                        </div>
                                                                        <% } %>
                                                                            <% if (file.professor) { %>
                                                                                <div class="file-meta-item">
                                                                                    <strong>Professor:</strong>
                                                                                    <%= file.professor %>
                                                                                </div>
                                                                                <% } %>
                                                                                    <% if (file.semester && file.year) {
                                                                                        %>
                                                                                        <div class="file-meta-item">
                                                                                            <strong>Term:</strong>
                                                                                            <%= file.semester %>
                                                                                                <%= file.year %>
                                                                                        </div>
                                                                                        <% } %>
                                                                                            <div class="file-meta-item">
                                                                                                <strong>Uploaded
                                                                                                    by:</strong>
                                                                                                <%= file.uploadedBy %>
                                                                                            </div>
                                                                                            <div class="file-meta-item">
                                                                                                <strong>Size:</strong>
                                                                                                <%= (file.size /
                                                                                                    1024).toFixed(1) %>
                                                                                                    KB
                                                                                            </div>
                                                                                            <% if (file.description) {
                                                                                                %>
                                                                                                <div
                                                                                                    class="file-meta-item">
                                                                                                    <strong>Description:</strong>
                                                                                                    <%= file.description
                                                                                                        %>
                                                                                                </div>
                                                                                                <% } %>
                                                </div>

                                                <div class="file-actions">
                                                    <a href="/download/<%= encodeURIComponent(file.filename) %>"
                                                        class="button primary" target="_blank">Download</a>
                                                    <% if (user.role==='viewer' ) { %>
                                                        <button class="button danger disabled"
                                                            onclick="showViewerAlert(); return false;"
                                                            title="View-only mode">Delete</button>
                                                        <% } else if (user.role==='admin' ||
                                                            file.uploadedBy===user.userid) { %>
                                                            <a href="/delete/<%= encodeURIComponent(file.filename) %>"
                                                                class="button danger"
                                                                onclick="return confirm('Are you sure you want to delete this file?')">Delete</a>
                                                            <% } else { %>
                                                                <button class="button danger disabled" disabled
                                                                    title="You can only delete your own files">Delete</button>
                                                                <% } %>
                                                                    <button class="button secondary small report-btn"
                                                                        data-filename="<%= file.filename %>"
                                                                        data-original-name="<%= file.originalName %>">üö©
                                                                        Report</button>
                                                </div>
                                            </div>
                                            <% }); %>
                                    </div>
                                    <% } %>
                        </section>

                        <section class="upload-section">
                            <% if (user.role==='viewer' ) { %>
                                <div class="upload-disabled">
                                    <div class="upload-disabled-content">
                                        <div class="upload-disabled-icon">üîí</div>
                                        <h4>Upload Restricted - View-Only Mode</h4>
                                        <p>Your account has been set to view-only access. You can download files but
                                            cannot upload or
                                            delete.</p>
                                        <p style="margin-top: 1rem;">Contact an administrator if you need upload/delete
                                            permissions.</p>
                                        <button class="button primary" style="margin-top: 1rem;"
                                            onclick="showViewerAlert()">
                                            Learn More
                                        </button>
                                    </div>
                                </div>
                                <% } else { %>
                                    <div class="upload-header">
                                        <h3>Upload Notes</h3>
                                        <p>Share your class notes with fellow Terps. Select one or multiple files!</p>
                                        <div class="file-type-notice">
                                            <strong>Supported File Types:</strong> Documents (.pdf, .docx, .pptx,
                                            .xlsx, .txt),
                                            Images (.jpg, .png, .gif, .svg), Code files (.py, .java, .c, .cpp, .js,
                                            .html, .css),
                                            Archives (.zip)
                                            <br>
                                            <small style="color: #6B7280; margin-top: 0.5rem; display: block;">
                                                üîí For your safety, we currently limit file types to those commonly used
                                                in academic
                                                settings. We're actively working on implementing virus scanning to
                                                support additional
                                                file formats in the future!
                                            </small>
                                        </div>
                                    </div>

                                    <form action="/upload" method="POST" enctype="multipart/form-data"
                                        class="upload-form" id="uploadForm">
                                        <div class="form-group">
                                            <label for="documents" class="form-label">
                                                Select Files<span class="required">*</span>
                                            </label>
                                            <div class="upload-drop-zone" id="dropZone">
                                                <input type="file" name="documents" id="documents" required
                                                    class="file-input-hidden" multiple />
                                                <div class="drop-zone-content">
                                                    <div class="drop-zone-icon">üìÅ</div>
                                                    <p class="drop-zone-text">
                                                        <strong>Click to browse</strong> or drag and drop files here
                                                    </p>
                                                    <p class="drop-zone-hint">
                                                        Upload one or multiple files (up to 50 files, 100MB each)
                                                    </p>
                                                    <p class="drop-zone-hint"
                                                        style="color: #10B981; font-size: 0.75rem; margin-top: 0.25rem;">
                                                        ‚úÖ Direct S3 uploads - no file size limits!
                                                    </p>
                                                </div>
                                                <div class="selected-files" id="selectedFiles"></div>
                                            </div>
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="classCode" class="form-label">Class Code<span
                                                        class="required">*</span></label>
                                                <input type="text" name="classCode" id="classCode" required
                                                    class="form-input" placeholder="e.g. CMSC330, HIST000" />
                                                <small class="form-help">For general notes: MAJOR000 (e.g.,
                                                    HIST000)</small>
                                            </div>

                                            <div class="form-group">
                                                <label for="professor" class="form-label">Professor<span
                                                        class="required">*</span></label>
                                                <input type="text" name="professor" id="professor" required
                                                    class="form-input" placeholder="e.g., Dr. Nelson, Prof. Smith" />
                                            </div>
                                        </div>

                                        <div class="form-row">
                                            <div class="form-group">
                                                <label for="semester" class="form-label">Semester<span
                                                        class="required">*</span></label>
                                                <select name="semester" id="semester" required class="form-input">
                                                    <option value="">Select semester</option>
                                                    <option value="Fall">Fall</option>
                                                    <option value="Spring">Spring</option>
                                                    <option value="Summer">Summer</option>
                                                    <option value="Winter">Winter</option>
                                                </select>
                                            </div>

                                            <div class="form-group">
                                                <label for="year" class="form-label">Year<span
                                                        class="required">*</span></label>
                                                <select name="year" id="year" required class="form-input">
                                                    <option value="">Select year</option>
                                                    <% for (let y=new Date().getFullYear() + 1; y>= 2020; y--) { %>
                                                        <option value="<%= y %>">
                                                            <%= y %>
                                                        </option>
                                                        <% } %>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label for="description" class="form-label">Description<span
                                                    class="required">*</span></label>
                                            <textarea name="description" id="description" class="form-textarea" required
                                                placeholder="e.g., Week 1 Lectures, Midterm Study Guide, Chapter 3 Summary"
                                                rows="2"></textarea>
                                            <small class="form-help">
                                                Examples: "Week 5 Lectures", "Midterm Review", "Chapter 1-3 Notes"
                                            </small>
                                        </div>

                                        <div class="form-actions">
                                            <button type="submit" class="button primary" id="uploadSubmitBtn">
                                                Upload Files
                                            </button>
                                        </div>
                                    </form>
                                    <% } %>
                        </section>
    </main>

    <!-- Floating Action Button for Upload -->
    <% if (user.role !=='viewer' ) { %>
        <button class="fab-upload" id="fabUpload" title="Upload Files">
            <span class="fab-icon">+</span>
            <span class="fab-text">Upload</span>
        </button>
        <% } %>

            <script type="application/json" id="filesData"><%- JSON.stringify(files) %></script>

            <!-- App.js functionality now integrated directly in pages -->
            <script>
                // Store all files data in JavaScript for client-side filtering
                const allFilesData = JSON.parse(document.getElementById('filesData').textContent);

                // Handle major filter change - updates class code dropdown
                function handleMajorChange() {
                    const classFilter = document.getElementById('classFilter');
                    const currentClass = classFilter.value;

                    // Update dropdown visibility
                    updateClassDropdownVisibility();

                    // If current class selection doesn't match the new major, clear it
                    const selectedMajor = document.getElementById('majorFilter').value;
                    if (currentClass && selectedMajor) {
                        const currentOption = classFilter.querySelector(`option[value="${currentClass}"]`);
                        if (currentOption && currentOption.dataset.major !== selectedMajor) {
                            classFilter.value = '';
                        }
                    }

                    // Apply filters (preserves semester, professor, etc.)
                    applyFilters();
                }

                // Handle class filter change - auto-set major to match
                function handleClassChange() {
                    const classFilter = document.getElementById('classFilter');
                    const majorFilter = document.getElementById('majorFilter');
                    const selectedClass = classFilter.value;

                    if (selectedClass) {
                        const selectedOption = classFilter.querySelector(`option[value="${selectedClass}"]`);
                        if (selectedOption) {
                            const classMajor = selectedOption.dataset.major;
                            // Auto-set major to match the class (without triggering change event)
                            if (majorFilter.value !== classMajor) {
                                majorFilter.value = classMajor;
                                // Update dropdown visibility without resetting filters
                                updateClassDropdownVisibility();
                            }
                        }
                    }

                    // Apply filters
                    applyFilters();
                }

                // Update class dropdown visibility based on major (helper function)
                function updateClassDropdownVisibility() {
                    const selectedMajor = document.getElementById('majorFilter').value;
                    const classFilter = document.getElementById('classFilter');
                    const allOptions = classFilter.querySelectorAll('option');

                    allOptions.forEach(option => {
                        if (option.value === '') {
                            option.style.display = 'block';
                        } else {
                            const optionMajor = option.dataset.major;
                            if (!selectedMajor || optionMajor === selectedMajor) {
                                option.style.display = 'block';
                            } else {
                                option.style.display = 'none';
                            }
                        }
                    });
                }

                // Toggle multi-select dropdown
                function toggleDropdown(type) {
                    const dropdown = document.getElementById(`${type}Dropdown`);
                    const allDropdowns = document.querySelectorAll('.multi-select-dropdown');

                    // Close other dropdowns
                    allDropdowns.forEach(dd => {
                        if (dd.id !== `${type}Dropdown`) {
                            dd.classList.remove('show');
                        }
                    });

                    // Toggle current dropdown
                    dropdown.classList.toggle('show');
                }

                // Update multi-select label and apply filters
                function updateMultiSelect(type) {
                    const checkboxes = document.querySelectorAll(`#${type}Dropdown input[type="checkbox"]:checked`);
                    const label = document.getElementById(`${type}Label`);
                    const values = Array.from(checkboxes).map(cb => cb.value);

                    if (values.length === 0) {
                        label.textContent = type === 'year' ? 'All Years' : 'All Semesters';
                    } else if (values.length === 1) {
                        label.textContent = values[0];
                    } else {
                        label.textContent = `${values.length} selected`;
                    }

                    applyFilters();
                }

                // Close dropdowns when clicking outside
                document.addEventListener('click', function (e) {
                    if (!e.target.closest('.multi-select-wrapper')) {
                        document.querySelectorAll('.multi-select-dropdown').forEach(dd => {
                            dd.classList.remove('show');
                        });
                    }
                });

                // Client-side filtering - instant, no page reloads!
                function applyFilters() {
                    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                    const majorFilter = document.getElementById('majorFilter').value;
                    const classFilter = document.getElementById('classFilter').value;
                    const professorFilter = document.getElementById('professorFilter').value.toLowerCase();
                    const sortBy = document.getElementById('sortFilter').value;
                    const myFilesOnly = document.getElementById('myFilesToggle').checked;

                    // Get multi-select values from checkboxes
                    const selectedYears = Array.from(document.querySelectorAll('#yearDropdown input[type="checkbox"]:checked'))
                        .map(cb => cb.value);
                    const selectedSemesters = Array.from(document.querySelectorAll('#semesterDropdown input[type="checkbox"]:checked'))
                        .map(cb => cb.value);

                    // Current user's userid for "My Files" filter
                    const currentUserid = '<%= user.userid %>';

                    // Filter files
                    let filteredFiles = allFilesData.filter(file => {
                        // "My Files" filter - show only files uploaded by current user
                        const matchesMyFiles = !myFilesOnly || file.uploadedBy === currentUserid;

                        // Search filter - searches by filename, uploader, class, description, and professor
                        const matchesSearch = !searchTerm ||
                            file.originalName.toLowerCase().includes(searchTerm) ||
                            file.uploadedBy.toLowerCase().includes(searchTerm) ||
                            (file.classCode && file.classCode.toLowerCase().includes(searchTerm)) ||
                            (file.description && file.description.toLowerCase().includes(searchTerm)) ||
                            (file.professor && file.professor.toLowerCase().includes(searchTerm));

                        // Major filter
                        const matchesMajor = !majorFilter || file.major === majorFilter;

                        // Class filter
                        const matchesClass = !classFilter || file.classCode === classFilter;

                        // Year filter (multi-select)
                        const matchesYear = selectedYears.length === 0 || selectedYears.includes(file.year);

                        // Semester filter (multi-select)
                        const matchesSemester = selectedSemesters.length === 0 || selectedSemesters.includes(file.semester);

                        // Professor filter
                        const matchesProfessor = !professorFilter ||
                            (file.professor && file.professor.toLowerCase().includes(professorFilter));

                        return matchesMyFiles && matchesSearch && matchesMajor && matchesClass && matchesYear && matchesSemester && matchesProfessor;
                    });

                    // Sort files
                    filteredFiles.sort((a, b) => {
                        switch (sortBy) {
                            case 'oldest':
                                return new Date(a.uploadDate) - new Date(b.uploadDate);
                            case 'name':
                                return a.originalName.localeCompare(b.originalName);
                            case 'newest':
                            default:
                                return new Date(b.uploadDate) - new Date(a.uploadDate);
                        }
                    });

                    // Update the DOM
                    displayFiles(filteredFiles);
                }

                function displayFiles(files) {
                    const fileGrid = document.querySelector('.file-grid');
                    const emptyState = document.querySelector('.empty-state');
                    const fileList = document.querySelector('.file-list');

                    if (files.length === 0) {
                        if (fileGrid) fileGrid.style.display = 'none';
                        if (!emptyState) {
                            fileList.innerHTML = '<div class="empty-state"><h3>No notes found</h3><p>Try different filters or search terms</p></div>';
                        } else {
                            emptyState.style.display = 'block';
                        }
                        return;
                    }

                    if (emptyState) emptyState.style.display = 'none';

                    if (!fileGrid) {
                        // Create file grid if it doesn't exist
                        fileList.innerHTML = '<div class="file-grid"></div>';
                    }

                    const grid = document.querySelector('.file-grid');
                    grid.style.display = 'grid';
                    grid.innerHTML = files.map(file => `
                <div class="file-card animate-fade-in">
                    <div class="file-header">
                        <div class="file-icon">üìÑ</div>
                        <div class="file-info">
                            <h3>${escapeHtml(file.originalName)}</h3>
                        </div>
                    </div>
                    <div class="file-meta">
                        ${file.virusScanStatus ? `<div class="file-meta-item"><strong>Security:</strong> ${getScanBadge(file.virusScanStatus)}</div>` : ''}
                        ${file.major ? `<div class="file-meta-item"><strong>Major:</strong> <span class="major-badge">${escapeHtml(file.major)}</span></div>` : ''}
                        ${file.classCode ? `<div class="file-meta-item"><strong>Class:</strong> <span class="class-code-badge">${escapeHtml(file.classCode)}</span></div>` : ''}
                        ${file.professor ? `<div class="file-meta-item"><strong>Professor:</strong> ${escapeHtml(file.professor)}</div>` : ''}
                        ${file.semester && file.year ? `<div class="file-meta-item"><strong>Term:</strong> ${file.semester} ${file.year}</div>` : ''}
                        <div class="file-meta-item"><strong>Uploaded by:</strong> ${escapeHtml(file.uploadedBy)}</div>
                        <div class="file-meta-item"><strong>Size:</strong> ${(file.size / 1024).toFixed(1)} KB</div>
                        ${file.description ? `<div class="file-meta-item"><strong>Description:</strong> ${escapeHtml(file.description)}</div>` : ''}
                    </div>
                    <div class="file-actions">
                        <a href="/download/${encodeURIComponent(file.filename)}" class="button primary" target="_blank">Download</a>
                        ${getDeleteButton(file)}
                        <button class="button secondary small report-btn" data-filename="${file.filename}" data-original-name="${escapeHtml(file.originalName)}">Report</button>
                    </div>
                </div>
            `).join('');
                }

                function canDeleteFile(file) {
                    const userRole = '<%= user.role %>';
                    const userId = '<%= user.userid %>';
                    return userRole === 'admin' || file.uploadedBy === userId;
                }

                function getDeleteButton(file) {
                    const userRole = '<%= user.role %>';
                    const userId = '<%= user.userid %>';

                    if (userRole === 'viewer') {
                        return `<button class="button danger disabled" onclick="showViewerAlert(); return false;" title="View-only mode">Delete</button>`;
                    } else if (userRole === 'admin' || file.uploadedBy === userId) {
                        return `<a href="/delete/${encodeURIComponent(file.filename)}" class="button danger" onclick="return confirm('Are you sure you want to delete this file?')">Delete</a>`;
                    } else {
                        return `<button class="button danger disabled" disabled title="You can only delete your own files">Delete</button>`;
                    }
                }

                function showViewerAlert() {
                    alert('üîí View-Only Mode\n\nYour account has been set to view-only access. You can download files but cannot upload or delete.\n\nPlease contact an administrator if you need upload/delete permissions.');
                }

                // Add event delegation for report buttons
                document.addEventListener('click', function (e) {
                    if (e.target.classList.contains('report-btn') || e.target.closest('.report-btn')) {
                        const btn = e.target.classList.contains('report-btn') ? e.target : e.target.closest('.report-btn');
                        const filename = btn.dataset.filename;
                        const originalName = btn.dataset.originalName;
                        reportFile(filename, originalName);
                    }
                });

                // File reporting function
                async function reportFile(filename, originalName) {
                    const reasons = [
                        'Inappropriate content',
                        'Copyright violation',
                        'Malicious file',
                        'Academic integrity violation (unauthorized exam/project)',
                        'Spam or irrelevant content',
                        'Other'
                    ];

                    const reason = prompt(`Why are you reporting "${originalName}"?\n\nEnter the reason:\n1. ${reasons[0]}\n2. ${reasons[1]}\n3. ${reasons[2]}\n4. ${reasons[3]}\n5. ${reasons[4]}\n6. ${reasons[5]}\n\nEnter number (1-6):`);

                    if (!reason) return; // User cancelled

                    const reasonIndex = parseInt(reason) - 1;
                    if (reasonIndex < 0 || reasonIndex >= reasons.length) {
                        alert('Invalid selection. Please try again.');
                        return;
                    }

                    const selectedReason = reasons[reasonIndex];
                    const additionalDetails = prompt(`Optional: Add more details about the issue:`) || '';

                    try {
                        const response = await fetch('/api/report-file', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                filename: filename,
                                originalName: originalName,
                                reason: selectedReason,
                                details: additionalDetails
                            })
                        });

                        const result = await response.json();

                        if (response.ok) {
                            alert('‚úÖ Report submitted successfully. An admin will review this file.');
                        } else {
                            alert('‚ùå Error: ' + result.error);
                        }
                    } catch (error) {
                        alert('‚ùå Failed to submit report. Please try again.');
                        console.error('Report error:', error);
                    }
                }

                function escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }

                function getScanBadge(status) {
                    if (status === 'clean') {
                        return '<span class="scan-badge scan-clean">‚úì Virus Scanned</span>';
                    } else if (status === 'pending') {
                        return '<span class="scan-badge scan-pending">‚è≥ Scanning...</span>';
                    } else if (status === 'error') {
                        return '<span class="scan-badge scan-error">‚ö†Ô∏è Scan Error</span>';
                    }
                    return '';
                }

                // Direct S3 Upload Form Handler
                const uploadForm = document.getElementById('uploadForm');
                if (uploadForm) {
                    uploadForm.addEventListener('submit', async function (e) {
                        e.preventDefault(); // Prevent default form submission

                        const submitBtn = document.getElementById('uploadSubmitBtn');
                        const filesInput = document.getElementById('documents');
                        const files = filesInput.files;

                        if (files.length === 0) {
                            alert('Please select at least one file');
                            return;
                        }

                        // Get form data
                        const classCode = document.getElementById('classCode').value.trim();
                        const professor = document.getElementById('professor').value.trim();
                        const semester = document.getElementById('semester').value;
                        const year = document.getElementById('year').value;
                        const description = document.getElementById('description').value.trim();

                        if (!classCode || !professor || !description) {
                            alert('Please fill in all required fields');
                            return;
                        }

                        // Disable submit button
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Uploading...';

                        // Show loading overlay
                        const overlay = document.createElement('div');
                        overlay.id = 'uploadOverlay';
                        overlay.innerHTML = `
                            <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); display: flex; align-items: center; justify-content: center; z-index: 9999;">
                                <div style="background: white; padding: 3rem; border-radius: 12px; text-align: center; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3); min-width: 400px;">
                                    <div style="width: 60px; height: 60px; border: 4px solid #E5E7EB; border-top-color: #DC2626; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 1.5rem;"></div>
                                    <h3 style="color: #DC2626; margin-bottom: 0.5rem;">Uploading Files...</h3>
                                    <p style="color: #6B7280;" id="uploadStatus">Preparing upload...</p>
                                    <p style="color: #9CA3AF; font-size: 0.85rem; margin-top: 1rem;">
                                        <span id="uploadProgress">0</span> / ${files.length} files ‚Ä¢ Direct S3 upload
                                    </p>
                                </div>
                            </div>
                            <style>
                                @keyframes spin {
                                    0% { transform: rotate(0deg); }
                                    100% { transform: rotate(360deg); }
                                }
                            </style>
                        `;
                        document.body.appendChild(overlay);

                        const statusEl = document.getElementById('uploadStatus');
                        const progressEl = document.getElementById('uploadProgress');

                        let successCount = 0;
                        let errorCount = 0;

                        // Upload each file
                        for (let i = 0; i < files.length; i++) {
                            const file = files[i];
                            statusEl.textContent = `Uploading ${file.name}...`;

                            try {
                                // Step 1: Get presigned URL
                                const urlResponse = await fetch('/api/get-upload-url', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        filename: file.name,
                                        filetype: file.type
                                    })
                                });

                                if (!urlResponse.ok) {
                                    throw new Error('Failed to get upload URL');
                                }

                                const { uploadUrl, s3Key, s3Url } = await urlResponse.json();

                                // Step 2: Upload directly to S3
                                const s3Response = await fetch(uploadUrl, {
                                    method: 'PUT',
                                    body: file,
                                    headers: {
                                        'Content-Type': file.type
                                    }
                                });

                                if (!s3Response.ok) {
                                    throw new Error('S3 upload failed');
                                }

                                // Step 3: Confirm upload to backend
                                const confirmResponse = await fetch('/api/confirm-upload', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({
                                        s3Key: s3Key,
                                        s3Url: s3Url,
                                        filename: file.name,
                                        filetype: file.type,
                                        filesize: file.size,
                                        classCode: classCode,
                                        professor: professor,
                                        semester: semester,
                                        year: year,
                                        description: description
                                    })
                                });

                                if (!confirmResponse.ok) {
                                    throw new Error('Failed to save file metadata');
                                }

                                const result = await confirmResponse.json();
                                if (result.duplicate) {
                                    statusEl.textContent = `${file.name} already exists (skipped)`;
                                } else {
                                    successCount++;
                                }

                            } catch (error) {
                                console.error('Upload error:', error);
                                errorCount++;
                                statusEl.textContent = `Error uploading ${file.name}`;
                            }

                            progressEl.textContent = i + 1;
                        }

                        // Show completion message
                        statusEl.textContent = `Upload complete! ${successCount} uploaded, ${errorCount} failed`;
                        setTimeout(() => {
                            window.location.reload();
                        }, 1500);
                    });
                }

                // Initialize on page load
                document.addEventListener('DOMContentLoaded', function () {
                    // Real-time search as you type
                    const searchInput = document.getElementById('searchInput');
                    if (searchInput) {
                        searchInput.addEventListener('input', applyFilters);
                    }

                    // Auto-uppercase class code input
                    const classCodeInput = document.getElementById('classCode');
                    if (classCodeInput) {
                        classCodeInput.addEventListener('input', function () {
                            this.value = this.value.toUpperCase();
                        });
                    }

                    // Initialize drag-and-drop upload
                    initDragAndDrop();

                    // Initialize Floating Action Button
                    initFAB();
                });

                // Drag and Drop Upload Functionality
                function initDragAndDrop() {
                    const dropZone = document.getElementById('dropZone');
                    const fileInput = document.getElementById('documents');
                    const selectedFilesContainer = document.getElementById('selectedFiles');

                    if (!dropZone || !fileInput) return;

                    // Click to browse
                    dropZone.addEventListener('click', () => {
                        fileInput.click();
                    });

                    // Prevent default drag behaviors
                    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                        dropZone.addEventListener(eventName, preventDefaults, false);
                        document.body.addEventListener(eventName, preventDefaults, false);
                    });

                    // Highlight drop zone when dragging over
                    ['dragenter', 'dragover'].forEach(eventName => {
                        dropZone.addEventListener(eventName, () => {
                            dropZone.classList.add('drag-over');
                        }, false);
                    });

                    ['dragleave', 'drop'].forEach(eventName => {
                        dropZone.addEventListener(eventName, () => {
                            dropZone.classList.remove('drag-over');
                        }, false);
                    });

                    // Handle dropped files
                    dropZone.addEventListener('drop', (e) => {
                        const dt = e.dataTransfer;
                        const files = dt.files;
                        fileInput.files = files;
                        displaySelectedFiles(files);
                    });

                    // Handle selected files via click
                    fileInput.addEventListener('change', (e) => {
                        displaySelectedFiles(e.target.files);
                    });

                    function preventDefaults(e) {
                        e.preventDefault();
                        e.stopPropagation();
                    }

                    function displaySelectedFiles(files) {
                        if (!files || files.length === 0) {
                            selectedFilesContainer.innerHTML = '';
                            return;
                        }

                        let totalSize = 0;
                        let html = '<div class="selected-files-header">üìé Selected Files:</div>';

                        Array.from(files).forEach((file, index) => {
                            const size = (file.size / 1024).toFixed(1);
                            totalSize += file.size;
                            const icon = getFileIcon(file.name);

                            html += `
                        <div class="file-item">
                            <div class="file-item-info">
                                <span class="file-item-icon">${icon}</span>
                                <span class="file-item-name">${escapeHtml(file.name)}</span>
                            </div>
                            <span class="file-item-size">${size} KB</span>
                        </div>
                    `;
                        });

                        const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
                        html += `<div class="files-summary">Total: ${files.length} file(s) ¬∑ ${totalSizeMB} MB</div>`;

                        selectedFilesContainer.innerHTML = html;
                    }

                    function getFileIcon(filename) {
                        const ext = filename.split('.').pop().toLowerCase();
                        const iconMap = {
                            pdf: 'üìï',
                            doc: 'üìò', docx: 'üìò',
                            xls: 'üìó', xlsx: 'üìó',
                            ppt: 'üìô', pptx: 'üìô',
                            txt: 'üìÑ',
                            zip: 'üì¶', rar: 'üì¶',
                            jpg: 'üñºÔ∏è', jpeg: 'üñºÔ∏è', png: 'üñºÔ∏è', gif: 'üñºÔ∏è',
                            mp4: 'üé•', mov: 'üé•',
                            mp3: 'üéµ',
                        };
                        return iconMap[ext] || 'üìÑ';
                    }
                }

                // Floating Action Button functionality
                function initFAB() {
                    const fab = document.getElementById('fabUpload');
                    const uploadSection = document.querySelector('.upload-section');

                    if (!fab || !uploadSection) return;

                    // Smooth scroll to upload section
                    fab.addEventListener('click', () => {
                        uploadSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

                        // Optional: Focus on the drop zone after scrolling
                        setTimeout(() => {
                            const dropZone = document.getElementById('dropZone');
                            if (dropZone) {
                                dropZone.style.animation = 'pulse 0.5s ease-in-out';
                                setTimeout(() => {
                                    dropZone.style.animation = '';
                                }, 500);
                            }
                        }, 500);
                    });

                    // Hide FAB when upload section is visible
                    const observer = new IntersectionObserver((entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                fab.style.opacity = '0';
                                fab.style.pointerEvents = 'none';
                            } else {
                                fab.style.opacity = '1';
                                fab.style.pointerEvents = 'all';
                            }
                        });
                    }, { threshold: 0.1 });

                    observer.observe(uploadSection);
                }
            </script>

            <%- include('partials/footer') %>
</body>

</html>
