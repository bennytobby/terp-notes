<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
        <%= title %>
    </title>
    <link rel="icon" type="image/png" href="/favicon.png" />
    <link rel="stylesheet" href="/styles/main.css" />
</head>

<body>
    <header class="topbar">
        <h2><a href="/dashboard" style="text-decoration: none; color: inherit; display: flex; align-items: center; cursor: pointer; transition: opacity 0.2s ease;" onmouseover="this.style.opacity='0.8'" onmouseout="this.style.opacity='1'">
            <img src="/logo.png" alt="Terp Notes Logo" style="width: 32px; height: 32px; vertical-align: middle; margin-right: 8px; pointer-events: none;" />
            Terp Notes
        </a></h2>
        <div class="user-info">
            Welcome, <strong>
                <%= user.firstname %>
            </strong>
            <span class="user-role role-<%= user.role %>">
                <%= user.role %>
            </span>
            <% if (user.role==='admin' ) { %>
                | <a href="/admin" class="logout-btn">Admin Panel</a>
                <% } %>
                    | <a href="/dashboard" class="logout-btn">Dashboard</a>
                    | <a href="/logout" class="logout-btn">Logout</a>
        </div>
    </header>

    <main class="container">
        <div class="profile-page">
            <h1>My Profile</h1>
            <p class="profile-subtitle">Manage your account information</p>

            <!-- Profile Information -->
            <section class="profile-section">
                <h2>Profile Information</h2>
                <form action="/update-profile" method="POST" class="profile-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstname">First Name</label>
                            <input type="text" id="firstname" name="firstname" value="<%= user.firstname %>" required>
                        </div>

                        <div class="form-group">
                            <label for="lastname">Last Name</label>
                            <input type="text" id="lastname" name="lastname" value="<%= user.lastname %>" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <input type="email" id="email" name="email" value="<%= user.email %>" required>
                    </div>

                    <div class="form-group">
                        <label for="userid">Username (Cannot be changed)</label>
                        <input type="text" id="userid" name="userid" value="<%= user.userid %>" disabled
                            class="disabled-input">
                        <small class="form-help"><img src="/images/icons/info-circle.png" alt="Info" style="width: 36px; height: 36px; vertical-align: middle; margin-right: 10px;" /> Your username is permanent and cannot be changed</small>
                    </div>

                    <div class="form-group">
                        <label>Account Role</label>
                        <div class="role-display">
                            <span class="user-role role-<%= user.role %>">
                                <%= user.role %>
                            </span>
                            <% if (user.role==='viewer' ) { %>
                                <small class="form-help">View-only access - Contact admin to change</small>
                                <% } %>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="button primary">Update Profile</button>
                        <a href="/dashboard" class="button secondary">Cancel</a>
                    </div>
                </form>
            </section>

            <!-- Change Password -->
            <section class="profile-section">
                <h2>Change Password</h2>
                <form action="/change-password" method="POST" class="profile-form">
                    <div class="form-group">
                        <label for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" name="currentPassword" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="newPassword">New Password</label>
                            <input type="password" id="newPassword" name="newPassword" required minlength="6">
                        </div>

                        <div class="form-group">
                            <label for="confirmPassword">Confirm New Password</label>
                            <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="button primary">Change Password</button>
                    </div>
                </form>
            </section>

            <!-- Account Information -->
            <section class="profile-section info-section">
                <h2>Account Information</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <strong>Account Created:</strong>
                        <span>
                            <%= user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'Unknown' %>
                        </span>
                    </div>
                    <% if (user.updatedAt) { %>
                        <div class="info-item">
                            <strong>Last Updated:</strong>
                            <span>
                                <%= new Date(user.updatedAt).toLocaleDateString() %>
                            </span>
                        </div>
                        <% } %>
                            <% if (user.isProtected) { %>
                                <div class="info-item">
                                    <strong>Account Type:</strong>
                                    <span class="protected-badge"><img src="/images/icons/shield-check.png" alt="Protected" style="width: 36px; height: 36px; vertical-align: middle; margin-right: 10px;" /> Protected System Account</span>
                                </div>
                                <% } %>
                </div>
            </section>

            <!-- DANGER ZONE -->
            <% if (!user.isProtected) { %>
                <section class="profile-section danger-zone">
                    <h2 class="danger-zone-title">ðŸš¨ DANGER ZONE</h2>


                    <!-- Delete Account -->
                    <div class="danger-section">
                        <h3>Delete Account</h3>
                        <div class="danger-warning">
                            <p><strong><img src="/images/icons/warning-triangle.png" alt="Warning" style="width: 40px; height: 40px; vertical-align: middle; margin-right: 10px;" /> Warning:</strong> This action cannot be undone. Deleting your account will permanently remove:</p>
                            <ul>
                                <li>Your profile and account information</li>
                                <li>Your download history and statistics</li>
                            </ul>
                            <p><strong>Note:</strong> Your uploaded files will be preserved for the community but attributed to "Deleted User" to protect your privacy.</p>
                            <p>If you're sure you want to delete your account, click the button below.</p>
                        </div>
                        <button type="button" id="deleteAccountBtn" class="button danger">
                            Delete My Account
                        </button>
                    </div>
                </section>
            <% } %>
        </div>
    </main>

    <script>
        // Profile form change detection
        document.addEventListener('DOMContentLoaded', function () {
            const profileForm = document.querySelector('form[action="/update-profile"]');
            const profileBtn = profileForm?.querySelector('button[type="submit"]');

            if (profileForm && profileBtn) {
                const initialValues = {
                    firstname: document.getElementById('firstname').value,
                    lastname: document.getElementById('lastname').value,
                    email: document.getElementById('email').value
                };

                function checkProfileChanges() {
                    const hasChanges =
                        document.getElementById('firstname').value !== initialValues.firstname ||
                        document.getElementById('lastname').value !== initialValues.lastname ||
                        document.getElementById('email').value !== initialValues.email;

                    profileBtn.disabled = !hasChanges;
                    profileBtn.classList.toggle('disabled', !hasChanges);
                }

                // Check on input
                profileForm.querySelectorAll('input:not([disabled])').forEach(input => {
                    input.addEventListener('input', checkProfileChanges);
                });

                // Initial check
                checkProfileChanges();
            }

            // Password form validation
            const passwordForm = document.querySelector('form[action="/change-password"]');
            const passwordBtn = passwordForm?.querySelector('button[type="submit"]');

            if (passwordForm && passwordBtn) {
                function checkPasswordFields() {
                    const currentPassword = document.getElementById('currentPassword').value;
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmPassword').value;

                    const allFilled = currentPassword && newPassword && confirmPassword;
                    const passwordsMatch = newPassword === confirmPassword;
                    const passwordsDifferent = currentPassword !== newPassword;

                    passwordBtn.disabled = !allFilled || !passwordsMatch || !passwordsDifferent;
                    passwordBtn.classList.toggle('disabled', !allFilled || !passwordsMatch || !passwordsDifferent);

                    // Show helpful messages for new password
                    const newPassInput = document.getElementById('newPassword');
                    const existingNewPassError = newPassInput.parentElement.querySelector('.password-error');

                    if (existingNewPassError) existingNewPassError.remove();

                    if (newPassword && currentPassword === newPassword) {
                        const errorDiv = document.createElement('small');
                        errorDiv.className = 'password-error';
                        errorDiv.style.color = '#EF4444';
                        errorDiv.style.display = 'block';
                        errorDiv.style.marginTop = '0.25rem';
                        errorDiv.textContent = 'New password must be different from current password';
                        newPassInput.parentElement.appendChild(errorDiv);
                    }

                    // Show password match validation for confirm password
                    const confirmPassInput = document.getElementById('confirmPassword');
                    const existingConfirmError = confirmPassInput.parentElement.querySelector('.password-match-error');

                    if (existingConfirmError) existingConfirmError.remove();

                    if (confirmPassword) {
                        if (!passwordsMatch) {
                            const errorDiv = document.createElement('small');
                            errorDiv.className = 'password-match-error';
                            errorDiv.style.color = '#EF4444';
                            errorDiv.style.display = 'block';
                            errorDiv.style.marginTop = '0.25rem';
                            errorDiv.textContent = 'Passwords do not match';
                            confirmPassInput.parentElement.appendChild(errorDiv);
                        } else if (newPassword) {
                            const successDiv = document.createElement('small');
                            successDiv.className = 'password-match-error';
                            successDiv.style.color = '#10B981';
                            successDiv.style.display = 'block';
                            successDiv.style.marginTop = '0.25rem';
                            successDiv.textContent = 'âœ“ Passwords match';
                            confirmPassInput.parentElement.appendChild(successDiv);
                        }
                    }
                }

                passwordForm.querySelectorAll('input[type="password"]').forEach(input => {
                    input.addEventListener('input', checkPasswordFields);
                });

                // Initial check
                checkPasswordFields();
            }

            // Delete account functionality
            const deleteAccountBtn = document.getElementById('deleteAccountBtn');
            if (deleteAccountBtn) {
                deleteAccountBtn.addEventListener('click', async function() {
                    // Create confirmation dialog
                    const confirmed = await customConfirm(
                        'FINAL WARNING\n\n' +
                        'You are about to permanently delete your account. This action cannot be undone.\n\n' +
                        'This will delete:\n' +
                        'â€¢ Your profile and account information\n' +
                        'â€¢ All files you\'ve uploaded\n' +
                        'â€¢ Your download history and statistics\n\n' +
                        'Are you absolutely sure you want to delete your account?\n\n' +
                        'Type "DELETE" in the next dialog to confirm.',
                        'Delete Account'
                    );

                    if (confirmed) {
                        const userConfirmation = await customPrompt(
                            'Type "DELETE" (in all caps) to confirm account deletion:',
                            'Type DELETE here...',
                            'DELETE'
                        );

                        if (userConfirmation === 'DELETE') {
                            // Show loading state
                            deleteAccountBtn.disabled = true;
                            deleteAccountBtn.textContent = 'Deleting Account...';
                            deleteAccountBtn.style.opacity = '0.6';

                            // Submit delete request
                            fetch('/delete-account', {
                                method: 'DELETE',
                                headers: {
                                    'Content-Type': 'application/json',
                                }
                            })
                            .then(async response => {
                                if (response.ok) {
                                    await customAlert('Account deleted successfully. You will be redirected to the home page.', 'success');
                                    window.location.href = '/';
                                } else {
                                    throw new Error('Failed to delete account');
                                }
                            })
                            .catch(async error => {
                                console.error('Error:', error);
                                await customAlert('Failed to delete account. Please try again or contact support.', 'error');
                                // Reset button state
                                deleteAccountBtn.disabled = false;
                                deleteAccountBtn.textContent = 'Delete My Account';
                                deleteAccountBtn.style.opacity = '1';
                            });
                        } else if (userConfirmation !== null) {
                            await customAlert('Account deletion cancelled. The confirmation text did not match.', 'warning');
                        }
                    }
                });
            }

        });
    </script>
    <%- include('partials/footer') %>
    <%- include('partials/custom-alerts') %>
</body>

</html>
